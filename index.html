<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Lara's Guide - Edimburgo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Roteamento -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

  <!-- SheetJS para ler Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --azul: #0077ff;
      --borda: #ddd;
      --texto: #333;
      --bg: #fff;
      --cinza-claro: #b6b6b6;
      --aviso-bg: #fff8e1;
      --aviso-borda: #ffd54f;
    }

    body { margin: 0; display: flex; flex-direction: column; height: 100vh; font-family: Arial, sans-serif; }
    #map { flex: 1; }

    /* Sidebar */
    #sidebar {
      position: fixed;
      top: 0;
      right: -100%;
      width: 80%;
      max-width: 320px;
      height: 100%;
      background: #fafafa;
      border-left: 1px solid var(--borda);
      padding: 12px;
      overflow-y: auto;
      transition: right 0.3s ease;
      z-index: 1000;
    }
    #sidebar.open { right: 0; }
    #sidebar h3 { margin-top: 0; }
    .category { margin-top: 10px; }
    .place {
      padding: 8px 6px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    .place:hover { background: #f0f0f0; }
    .place-label { flex: 1; }
    .place.completed .place-label {
      text-decoration: line-through;
      color: var(--cinza-claro);
    }
    .place input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }

    /* Bot√£o abrir sidebar (hamburger) - canto superior direito */
    #toggleSidebar {
      position: fixed;
      top: 10px;
      right: 10px;     /* canto superior direito */
      left: auto;
      background: var(--azul);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 16px;
      cursor: pointer;
      z-index: 1100;
    }

    /* Barra de bot√µes inferior */
    #menu {
      display: flex;
      justify-content: space-around;
      background: var(--bg);
      border-top: 1px solid var(--borda);
      padding: 8px;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }
    #menu button {
      flex: 1;
      margin: 0 5px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #f7f7f7;
      color: var(--texto);
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    #menu button:hover { background: #e9e9e9; }
    #menu button.active { background: var(--azul); color: white; border-color: var(--azul); }

    /* Aviso quando n√£o encontra locais.xlsx */
    #excelNotice {
      position: fixed;
      top: 60px;
      right: 10px;
      background: var(--aviso-bg);
      border: 1px solid var(--aviso-borda);
      border-radius: 8px;
      padding: 10px 12px;
      z-index: 1100;
      display: none;
      max-width: 280px;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
      font-size: 14px;
    }

    /* Desktop: sidebar fixa */
    @media (min-width: 768px) {
      body { flex-direction: row; }
      #map { flex: 3; }
      #sidebar {
        position: static;
        width: 320px;
        max-width: none;
        border-left: 1px solid var(--borda);
        transition: none;
      }
      #toggleSidebar { display: none; }
      #excelNotice { top: 10px; }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Bot√£o abre/fecha sidebar (hamburger) -->
  <button id="toggleSidebar" aria-label="Abrir lista">‚ò∞ Locais</button>

  <!-- Aviso somente se n√£o encontrar locais.xlsx -->
  <div id="excelNotice">
    ‚ö†Ô∏è N√£o foi poss√≠vel carregar <b>locais.xlsx</b>.<br>
    Coloque o arquivo <b>locais.xlsx</b> na mesma pasta deste HTML e recarregue a p√°gina.
  </div>

  <!-- Sidebar -->
  <div id="sidebar">
    <h3 id="sidebar-title">Locais</h3>
    <div id="places"></div>
  </div>

  <!-- Barra de bot√µes -->
  <div id="menu">
    <button onclick="showView('home')" id="btn-home" class="active">Home</button>
    <button onclick="showView('perto')" id="btn-perto">Perto de Mim</button>
    <button onclick="showView('dia1')" id="btn-dia1">Dia 1</button>
    <button onclick="showView('dia2')" id="btn-dia2">Dia 2</button>
    <button onclick="showView('dia3')" id="btn-dia3">Dia 3</button>
  </div>

  <script>
    // --- Mapa ---
    const map = L.map('map').setView([55.9533, -3.1883], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

    let userMarker;
    let routingControl;
    let currentView = "home";
    let locais = []; // via locais.xlsx
    const createdMarkers = [];

    // Estado (checkbox) em localStorage
    function placeKey(place) { return `done:${(place.nome||'').toLowerCase().trim()}::${(place.dia||'').toLowerCase().trim()}`; }
    function isCompleted(place) { try { return localStorage.getItem(placeKey(place)) === '1'; } catch { return false; } }
    function setCompleted(place, value) {
      try { value ? localStorage.setItem(placeKey(place),'1') : localStorage.removeItem(placeKey(place)); } catch {}
      if (place.marker) place.marker.setOpacity(value ? 0.35 : 1);
    }

    // Carregamento OBRIGAT√ìRIO de locais.xlsx (sem upload)
    (async function loadFixedExcel(){
      try {
        const resp = await fetch('locais.xlsx', { cache: 'no-store' });
        if (!resp.ok) throw new Error('Sem locais.xlsx');
        const ab = await resp.arrayBuffer();
        parseExcelArrayBuffer(ab);
      } catch (e) {
        // Exibe aviso e n√£o tenta mais nada
        document.getElementById('excelNotice').style.display = 'block';
      }
    })();

    // Converte "Menu" em link para o menu da p√°gina
    function linkifyMenu(text) {
      if (!text) return '';
      return text.replace(/(\bmenu\b)/gi, '<a href="#menu" onclick="goToMenu(); return false;">$1</a>');
    }
    function goToMenu() {
      document.getElementById('menu').scrollIntoView({ behavior: 'smooth', block: 'end' });
    }

    function parseExcelArrayBuffer(ab) {
      const wb = XLSX.read(ab, { type: 'array' });
      const firstSheet = wb.SheetNames[0];
      const json = XLSX.utils.sheet_to_json(wb.Sheets[firstSheet], { defval: '' });

      // Colunas esperadas: categoria, nome, latitude, longitude, icone, endereco, descricao, dia, popup_text, (opcional) ordem
      locais = json.map((r, idx) => ({
        categoria: r.categoria || 'Outros',
        nome: r.nome || `Ponto ${idx+1}`,
        coords: [Number(r.latitude) || 0, Number(r.longitude) || 0],
        icone: r.icone || 'https://cdn-icons-png.flaticon.com/512/854/854878.png',
        endereco: r.endereco || '',
        descricao: r.descricao || '',
        dia: (r.dia || 'home').toString().trim().toLowerCase(),
        popup_text: r.popup_text || '',
        ordem: (r.ordem !== '' && r.ordem !== null && r.ordem !== undefined) ? Number(r.ordem) : null,
        _rowIndex: idx
      }));

      createMarkers();
      updateSidebar();
    }

    function createMarkers() {
      createdMarkers.forEach(m => map.removeLayer(m));
      createdMarkers.length = 0;

      locais.forEach(l => {
        const icon = L.icon({ iconUrl: l.icone, iconSize: [32,32] });
        const marker = L.marker(l.coords, { icon }).addTo(map);

        const urlGM = l.endereco
          ? `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(l.endereco)}`
          : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(l.nome)}`;

        const popupMenuHtml = linkifyMenu(l.popup_text);
        const popupHtml = `
          <div style="min-width:200px">
            <b>${l.nome}</b><br>
            ${l.endereco ? `${l.endereco}<br>` : ""}
            ${l.descricao ? `${l.descricao}<br>` : ""}
            ${popupMenuHtml ? `${popupMenuHtml}<br>` : ""}
            <a href="${urlGM}" target="_blank">üìç Mandar para o Google Maps</a>
          </div>
        `;
        marker.bindPopup(popupHtml);

        l.marker = marker;
        marker.setOpacity(isCompleted(l) ? 0.35 : 1);

        createdMarkers.push(marker);
      });
    }

    // Geolocaliza√ß√£o do usu√°rio (para "Perto de Mim" e rotas)
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const coords = [pos.coords.latitude, pos.coords.longitude];
        map.setView(coords, 15);
        userMarker = L.marker(coords, {
          icon: L.icon({ iconUrl:"https://cdn-icons-png.flaticon.com/512/149/149071.png", iconSize:[30,30] })
        }).addTo(map).bindPopup("Voc√™ est√° aqui");
        updateSidebar();
      }, () => updateSidebar());
    } else updateSidebar();

    // Troca de aba
    function showView(view) {
      currentView = view;

      document.querySelectorAll("#menu button").forEach(btn => btn.classList.remove("active"));
      const btn = document.getElementById("btn-" + view);
      if (btn) btn.classList.add("active");

      updateSidebar();
    }

    function updateSidebar() {
      const placesDiv = document.getElementById("places");
      placesDiv.innerHTML = "";

      if (!Array.isArray(locais) || locais.length === 0) {
        placesDiv.innerHTML = "<p>Nenhum local carregado. Verifique o arquivo <b>locais.xlsx</b>.</p>";
        return;
      }

      // Esconde/mostra marcadores conforme a view
      locais.forEach(l => { if (l.marker) map.removeLayer(l.marker); });

      let locaisFiltrados = [];
      let titulo = "Locais";

      if (currentView === "home") {
        locaisFiltrados = locais;
        titulo = "Todos os Locais";
      } else if (currentView === "perto" && userMarker) {
        const userCoords = userMarker.getLatLng();
        locaisFiltrados = locais.filter(l => map.distance(userCoords, l.coords) <= 500);
        locaisFiltrados.forEach(l => l.distancia = map.distance(userCoords, l.coords));
        titulo = "Locais at√© 500m";
      } else if (["dia1","dia2","dia3"].includes(currentView)) {
        locaisFiltrados = locais.filter(l => (l.dia || '').toLowerCase() === currentView);
        const anyOrdem = locaisFiltrados.some(l => typeof l.ordem === 'number' && !Number.isNaN(l.ordem));
        if (anyOrdem) {
          locaisFiltrados.sort((a,b) => {
            const ao = (typeof a.ordem === 'number' && !Number.isNaN(a.ordem)) ? a.ordem : Infinity;
            const bo = (typeof b.ordem === 'number' && !Number.isNaN(b.ordem)) ? b.ordem : Infinity;
            return ao - bo || (a._rowIndex - b._rowIndex);
          });
        }
        titulo = "Roteiro " + currentView.replace("dia","Dia ");
      } else if (currentView === "perto") {
        locaisFiltrados = [];
        titulo = "Perto de Mim (habilite a localiza√ß√£o)";
      } else {
        locaisFiltrados = locais;
        titulo = "Todos os Locais";
      }

      document.getElementById("sidebar-title").innerText = titulo;

      // Render da lista + recolocar marcadores
      if (["dia1","dia2","dia3"].includes(currentView)) {
        locaisFiltrados.forEach(place => {
          if (place.marker) place.marker.addTo(map);

          const row = document.createElement("div");
          row.classList.add("place");
          row.onclick = (e) => {
            if (e.target && e.target.matches('input[type="checkbox"]')) return;
            focusOnPlace(place);
            if (window.innerWidth < 768) toggleSidebar();
          };

          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.checked = isCompleted(place);
          cb.addEventListener("change", () => {
            setCompleted(place, cb.checked);
            row.classList.toggle("completed", cb.checked);
          });

          const label = document.createElement("div");
          label.classList.add("place-label");
          label.textContent = place.nome;

          row.appendChild(cb);
          row.appendChild(label);
          row.classList.toggle("completed", cb.checked);

          placesDiv.appendChild(row);
        });
      } else {
        // Home & Perto: agrupado por categoria (ordem alfab√©tica + nomes)
        const categorias = {};
        locaisFiltrados.forEach(l => { if (!categorias[l.categoria]) categorias[l.categoria] = []; categorias[l.categoria].push(l); });

        Object.keys(categorias).sort((a,b)=>a.localeCompare(b)).forEach(cat => {
          const catDiv = document.createElement("div");
          catDiv.classList.add("category");
          catDiv.innerHTML = `<h4>${cat}</h4>`;

          categorias[cat].sort((a,b)=> (a.nome||"").localeCompare(b.nome||""));

          categorias[cat].forEach(place => {
            if (place.marker) place.marker.addTo(map);

            const pDiv = document.createElement("div");
            pDiv.classList.add("place");
            const label = document.createElement("div");
            label.classList.add("place-label");
            label.textContent = place.nome;
            pDiv.appendChild(label);

            pDiv.onclick = () => {
              focusOnPlace(place);
              if (window.innerWidth < 768) toggleSidebar();
            };

            if (isCompleted(place)) pDiv.classList.add("completed");

            catDiv.appendChild(pDiv);
          });
          placesDiv.appendChild(catDiv);
        });
      }
    }

    function focusOnPlace(place) {
      map.setView(place.coords, 16);
      if (place.marker) place.marker.openPopup();

      if (userMarker) {
        if (routingControl) map.removeControl(routingControl);
        routingControl = L.Routing.control({
          waypoints: [ userMarker.getLatLng(), L.latLng(place.coords) ],
          createMarker: () => null,
          routeWhileDragging: false
        }).addTo(map);
      }
    }

    // Sidebar (mobile)
    const sidebar = document.getElementById("sidebar");
    document.getElementById("toggleSidebar").addEventListener("click", toggleSidebar);
    function toggleSidebar() { sidebar.classList.toggle("open"); }
  </script>
</body>
</html>
