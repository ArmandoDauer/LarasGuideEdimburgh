<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Lara's Guide - Edimburgo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- SheetJS para ler Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --azul: #0077ff;
      --borda: #ddd;
      --texto: #333;
      --bg: #fff;
      --cinza-claro: #b6b6b6;
      --aviso-bg: #fff8e1;
      --aviso-borda: #ffd54f;
    }

    body { margin: 0; display: flex; flex-direction: column; height: 100vh; font-family: Arial, sans-serif; }
    #map { flex: 1; }

    /* Sidebar */
    #sidebar {
      position: fixed;
      top: 0;
      right: -100%;
      width: 80%;
      max-width: 320px;
      height: 100%;
      background: #fafafa;
      border-left: 1px solid var(--borda);
      padding: 12px;
      overflow-y: auto;
      transition: right 0.3s ease;
      z-index: 1000;
    }
    #sidebar.open { right: 0; }
    #sidebar h3 { margin-top: 0; }
    .category { margin-top: 10px; }
    .place {
      padding: 8px 6px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    .place:hover { background: #f0f0f0; }
    .place-label { flex: 1; }
    .place.completed .place-label {
      text-decoration: line-through;
      color: var(--cinza-claro);
    }
    .place input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }

    /* Bot√£o abrir sidebar */
    #toggleSidebar {
      position: fixed;
      top: 10px;
      right: 10px;
      background: var(--azul);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 16px;
      cursor: pointer;
      z-index: 1100;
    }

    /* Bot√£o centralizar usu√°rio */
    #centerUser {
      position: fixed;
      bottom: 70px;
      right: 10px;
      background: var(--azul);
      color: white;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      font-size: 20px;
      cursor: pointer;
      z-index: 1100;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }

    /* Barra de bot√µes inferior */
    #menu {
      display: flex;
      justify-content: space-around;
      background: var(--bg);
      border-top: 1px solid var(--borda);
      padding: 8px;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }
    #menu button {
      flex: 1;
      margin: 0 5px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #f7f7f7;
      color: var(--texto);
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    #menu button:hover { background: #e9e9e9; }
    #menu button.active { background: var(--azul); color: white; border-color: var(--azul); }

    #excelNotice {
      position: fixed;
      top: 60px;
      right: 10px;
      background: var(--aviso-bg);
      border: 1px solid var(--aviso-borda);
      border-radius: 8px;
      padding: 10px 12px;
      z-index: 1100;
      display: none;
      max-width: 280px;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
      font-size: 14px;
    }

    @media (min-width: 768px) {
      body { flex-direction: row; }
      #map { flex: 3; }
      #sidebar { position: static; width: 320px; max-width: none; border-left: 1px solid var(--borda); transition: none; }
      #toggleSidebar { display: none; }
      #excelNotice { top: 10px; }
    }
  
    /* Previs√£o do tempo (badge ao lado do +/‚àí do mapa) */
    #weatherControl {
      background: rgba(255,255,255,.92);
      border: 1px solid var(--borda);
      border-radius: 8px;
      padding: 4px 8px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      line-height: 1;
      box-shadow: 0 1px 3px rgba(0,0,0,.15);
      user-select: none;
      cursor: default;
    }
    #weatherControl .wx-emoji { font-size: 16px; }
    #weatherControl .wx-temps b { font-weight: 700; }
    /* posiciona lateralmente ao controle de zoom do Leaflet */
    .leaflet-top.leaflet-left #weatherControl { margin-left: 46px; margin-top: 2px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <button id="toggleSidebar" aria-label="Abrir lista">‚ò∞ Locais</button>
  <button id="centerUser" title="Centralizar no usu√°rio">üìç</button>
  <div id="excelNotice">‚ö†Ô∏è N√£o foi poss√≠vel carregar <b>locais.xlsx</b>. Coloque o arquivo na mesma pasta.</div>

  <div id="sidebar">
    <h3 id="sidebar-title">Locais</h3>
    <div id="places"></div>
  </div>

  <div id="menu">
    <button onclick="showView('home')" id="btn-home" class="active">Home</button>
    <button onclick="showView('perto')" id="btn-perto">Perto de Mim</button>
    <button onclick="showView('armando')" id="btn-armando">Com Armando</button>
    <button onclick="showView('bath')" id="btn-bath">Bath</button>
  </div>

  <script>
    const map = L.map('map').setView([55.9533, -3.1883], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);

    // --- Previs√£o do tempo (Edimburgo) ---
    const DEFAULT_WEATHER = { lat: 55.9533, lon: -3.1883 };
    let lastWeatherCoords = DEFAULT_WEATHER;
    const WeatherControl = L.Control.extend({
      options: { position: 'topleft' },
      onAdd: function(){
        const div = L.DomUtil.create('div');
        div.id = 'weatherControl';
        div.title = 'Previs√£o de hoje em Edimburgo';
        div.innerHTML = '<span class="wx-emoji">‚õÖ</span><span class="wx-temps"><b>--¬∞C</b>/<span>--¬∞C</span></span>';
        L.DomEvent.disableClickPropagation(div);
        return div;
      }
    });
    map.addControl(new WeatherControl());

    function weatherIconFor(code){
      if(code===0) return '‚òÄÔ∏è';
      if(code===1 || code===2) return 'üå§Ô∏è';
      if(code===3) return '‚òÅÔ∏è';
      if(code===45 || code===48) return 'üå´Ô∏è';
      if([51,53,55,56,57].includes(code)) return 'üå¶Ô∏è';
      if([61,63,65,66,67,80,81,82].includes(code)) return 'üåßÔ∏è';
      if([71,73,75,77,85,86].includes(code)) return 'üå®Ô∏è';
      if([95,96,99].includes(code)) return '‚õàÔ∏è';
      return '‚õÖ';
    }

    async function fetchWeather(coords = lastWeatherCoords){
      try{
        lastWeatherCoords = coords || DEFAULT_WEATHER;
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lastWeatherCoords.lat}&longitude=${lastWeatherCoords.lon}&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=auto&forecast_days=1`;
        const resp = await fetch(url, { cache: 'no-store' });
        const j = await resp.json();
        const max = j?.daily?.temperature_2m_max?.[0];
        const min = j?.daily?.temperature_2m_min?.[0];
        const code = j?.daily?.weathercode?.[0];
        const el = document.getElementById('weatherControl');
        if(el && max != null && min != null){
          const emoji = weatherIconFor(code);
          el.innerHTML = `<span class="wx-emoji">${emoji}</span><span class="wx-temps"><b>${Math.round(max)}¬∞C</b>/<span>${Math.round(min)}¬∞C</span></span>`;
        }
      }catch(e){ /* silencia falhas */ }
    }
    fetchWeather(DEFAULT_WEATHER);

    let userMarker;
    let currentView = "home";
    let locais = [];
    const createdMarkers = [];

    function placeKey(p){ return `done:${(p.nome||'').toLowerCase()}::${(p.dia||'').toLowerCase()}`; }
    function isCompleted(p){ return localStorage.getItem(placeKey(p))==='1'; }
    function setCompleted(p,v){ v?localStorage.setItem(placeKey(p),'1'):localStorage.removeItem(placeKey(p)); if(p.marker) p.marker.setOpacity(v?0.35:1); }

    // Carrega locais.xlsx
    (async function(){
      try {
        const resp = await fetch('locais.xlsx',{cache:'no-store'});
        if(!resp.ok) throw new Error();
        const ab = await resp.arrayBuffer();
        parseExcel(ab);
      } catch(e){ document.getElementById('excelNotice').style.display='block'; }
    })();

    function linkifyMenu(t){ return t?t.replace(/(\bmenu\b)/gi,'<a href="#menu" onclick="goToMenu();return false;">$1</a>'):""; }
    function goToMenu(){ document.getElementById('menu').scrollIntoView({behavior:'smooth'}); }

    function parseExcel(ab){
      const wb=XLSX.read(ab,{type:'array'}); const sh=wb.SheetNames[0];
      const data=XLSX.utils.sheet_to_json(wb.Sheets[sh],{defval:''});
      locais=data.map((r,i)=>({categoria:r.categoria||'Outros',nome:r.nome||`Ponto ${i+1}`,coords:[+r.latitude||0,+r.longitude||0],
        icone:r.icone||'https://cdn-icons-png.flaticon.com/512/854/854878.png',endereco:r.endereco||'',descricao:r.descricao||'',
        dia:(r.dia||'home').toLowerCase(),popup_text:r.popup_text||'',ordem:r.ordem?+r.ordem:null,_rowIndex:i}));
      createMarkers(); updateSidebar();
    }

    function createMarkers(){
      createdMarkers.forEach(m=>map.removeLayer(m)); createdMarkers.length=0;
      locais.forEach(l=>{
        const ic=L.icon({iconUrl:l.icone,iconSize:[32,32]});
        const m=L.marker(l.coords,{icon:ic}).addTo(map);
        const url=l.endereco?`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(l.endereco)}`:`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(l.nome)}`;
        const pop=`<b>${l.nome}</b><br>${l.endereco?l.endereco+'<br>':''}${l.descricao?l.descricao+'<br>':''}${linkifyMenu(l.popup_text)}<br>
                   <a href="${url}" target="_blank">üìç Mandar para o Google Maps</a>`;
        m.bindPopup(pop);
        l.marker=m; m.setOpacity(isCompleted(l)?0.35:1); createdMarkers.push(m);
      });
    }

    // Geolocaliza√ß√£o
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(p=>{
        const c=[p.coords.latitude,p.coords.longitude];
        map.setView(c,15);
        userMarker=L.marker(c,{icon:L.icon({iconUrl:"https://cdn-icons-png.flaticon.com/512/149/149071.png",iconSize:[30,30]})})
          .addTo(map).bindPopup("Voc√™ est√° aqui");
        fetchWeather({ lat: c[0], lon: c[1] });
        updateSidebar();
      },()=>{ updateSidebar(); /* mant√©m a previs√£o padr√£o de Edimburgo */ });
    } else updateSidebar();

    // Bot√£o centralizar
    document.getElementById("centerUser").onclick=()=>{
      if(userMarker){
        map.setView(userMarker.getLatLng(),15);
        userMarker.openPopup();
      } else {
        alert("Posi√ß√£o do usu√°rio n√£o encontrada.");
      }
    };

    function showView(v){
      currentView=v;
      document.querySelectorAll("#menu button").forEach(b=>b.classList.remove("active"));
      const btn=document.getElementById("btn-"+v); if(btn) btn.classList.add("active");
      updateSidebar();
      if(window.innerWidth<768) sidebar.classList.add('open'); // abre a lista como no "Perto de Mim"
    }

    function updateSidebar(){
      const div=document.getElementById("places"); div.innerHTML="";
      locais.forEach(l=>{if(l.marker) map.removeLayer(l.marker);});
      let list=[]; let tit="Locais";

      if(currentView==="home"){ list=locais; tit="Todos"; }
      else if(currentView==="perto"&&userMarker){ list=locais.filter(l=>map.distance(userMarker.getLatLng(),l.coords)<=500); tit="At√© 500m"; }
      else if(currentView==="perto"&&!userMarker){ list=[]; tit="Perto de Mim"; }
      else if(["armando","bath"].includes(currentView)){
        list=locais.filter(l=>l.dia===currentView);
        list.sort((a,b)=>(a.ordem||a._rowIndex)-(b.ordem||b._rowIndex));
        tit = currentView==='armando' ? 'Com Armando' : 'Bath';
      }

      document.getElementById("sidebar-title").innerText=tit;

      // Agrupa por categoria
      const groups = {};
      list.forEach(p=>{ if(p.marker) p.marker.addTo(map); (groups[p.categoria] ||= []).push(p); });
      const cats = Object.keys(groups).sort((a,b)=>a.localeCompare(b,'pt'));

      cats.forEach(cat=>{
        // t√≠tulo da categoria
        const h=document.createElement('div');
        h.className='category';
        h.innerHTML = `<strong>${cat}</strong>`;
        div.appendChild(h);

        // ordena itens dentro da categoria
        groups[cat].sort((a,b)=> (a.ordem??a._rowIndex) - (b.ordem??b._rowIndex));
        groups[cat].forEach(p=>{
          const row=document.createElement("div"); row.className="place";
          const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=isCompleted(p);
          cb.onchange=()=>{ setCompleted(p,cb.checked); row.classList.toggle("completed",cb.checked); };
          const lab=document.createElement("div"); lab.className="place-label"; lab.textContent=p.nome;
          row.append(cb,lab); row.classList.toggle("completed",cb.checked);
          row.onclick=e=>{ if(e.target.tagName==="INPUT")return; map.setView(p.coords,16); if(p.marker) p.marker.openPopup(); sidebar.classList.remove('open'); };
          div.appendChild(row);
        });
      });

      // Quando a lista est√° vazia, deixa o mapa sem marcadores (al√©m do usu√°rio) ‚Äî comportamento igual ao "Perto de Mim" sem posi√ß√£o
    }

    const sidebar=document.getElementById("sidebar");
    document.getElementById("toggleSidebar").onclick=()=>sidebar.classList.toggle("open");
  </script>
</body>
</html>
